# 移动端音视频入门

## 1. 直播产品的种类

### 1.1 泛娱乐化直播

> 花椒、映客等娱乐直播，还有斗鱼、熊猫等游戏直播

<img src="assets/1.1 泛娱乐化直播架构.png" style="zoom:75%;" />

- 共享端（主播端）：发起信令（礼物、聊天、创建房间）到`信令服务器`
- 信令服务器：收到信令后做一些相应的逻辑处理
- 流媒体云：即 通常所说的 **CDN 网络**,**对音视频流进行转发**，CDN 网络是泛娱乐直播中的最重要的部分。
- 观看端：收看节目

直播的流程：

- 共享端发送一个信令到信令服务器请求创建一个房间
- 信令服务器收到房间创建请求，在服务端创建一个房间，返回给共享端一个**流媒体云地址**
- 共享端采集自己音视频数据，形成 rtmp 流推送到 CDN 网络
- 观众端想观看直播，观众端客户端发送一条数据到信令服务器，信令服务器将该观众加入到该直播间，同时返回一个流媒体云地址
- 观众根据流媒体云地址，到CDN 网络拉取想看的流。

### 1.2 实时互动直播

> 音视频会议、教育直播，像思科、全时、声网

<img src="assets/1.2 实时互动直播架构.png" style="zoom:75%;" />

- TCP 协议：发送、确认、超时、重传

- UDP：有包就发，不关心对方是否收到

- 而音频数据有时效性，我现在说的话必须现在听到，过一会听到就失去了意义，所以UDP符合应用。

- TCP 有很成熟的 CDN 网络，而 UDP 没有，需要自己创建
- 为了提供可靠的 7*24h 服务，需要在服务端设置多个节点，一旦某个节点出现了问题，可以将服务切换到另一个节点，同时可以保证负载均衡。
- 因为节点多，所以需要一个控制中心。每个节点需要定期向控制中心进行报告 CUP 占用、网络占用等情况。控制中心根据当前节点的状况，分配任务。
- 节点与控制中心通信使用 `内总线`,可以保证数据安全，及高的吞吐量
- 有了实时互动架构以后与泛娱乐架构需要融合，实时互动网络使用 `UDP ` 网络进行通信，将 rtp 包通过 `内部总线`传输到 `媒体服务器` ,CDN 使用的是 rtmp 协议，所以媒体服务器需要将 `rtp`转换到 `rtmp`。
- 融合好的数据，推送到 CDN 网络。

## 2. CDN 网络

> CDN 网络是为了：解决用户访问网络资源慢而出现的一种数据。

- 为什么会出现用户访问资源慢呢？
    - 链路过长
    - 运营商与其它运营商之间的切割，访问限制

### 2.1 CDN 构成

- 边缘节点：用户从边缘节点上（离自己最近，访问速度最快的节点）获取数据
- 二级节点（主干节点）：主干网络节点，用于缓存，减轻源站压力。用户首先访问自己的边缘节点，如果边缘节点有数据直接返回给用户，否则向上请求主干节点，将主干节点缓存的数据拉到自己的边缘节点上，然后将数据返回给用户。
- 源站节点：CP(内容提供商)将内容放到源站。如果主干节点也没数据，主干节点自动向源站请求数据。

### 2.2 CDN 网络拓扑

<img src="assets/2.2 CDN网络拓扑.png" style="zoom:75%;" />

- 每个运营商内部都要建自己的网络，例如:中国电信运营商，中国联通运营商
- 每个运营商网络内部都有多个**源节点**进行均衡负载。
- 为了解决运营商之间的限制，将两个运营商网络使用**主干节点，使用光纤对接**
- 用户访问资源流程
    - 用户(电信用户)通过 DNS ，或者HTTP的一个服务找到就近接入节点（边缘节点）
    - 向边缘节点请求数据，如果有直接返回给用户，如果没有向主干节点请求数据
    - 主干节点如果有数据则返回给边缘节点，否则查询该服务是由电信提供，还是由联通提供
    - 查询联通主干节点是否有数据，或者直接查询源节点

## 3. 搭建流媒体服务

- 准备流媒体服务器（Linux 或 Mac)

- 编译并安装 Nginx 服务

- 配置 RTMP 服务并启动 Nginx 服务

    ```
    # nginx 的 nginx.conf
    # 配置 rtmp server
    rtmp {                #RTMP服务
       server {
           listen 1935;  #//服务端口
            chunk_size 4096;   #//数据传输块的大小
           # 直播 指定流应用
           application live {
    	live on;
    	record off; # 关闭录制
    	allow play all; # 允许任何人发起请求
    	}
    	# 点播
            application vod {
                    play /home/annjeff/videoStore/vod; #//视频文件存放位置。
            }
       }
    }
    
    # nginx 默认监听端口是 80,被占用建议更改为:8080
    ```

- FFmpeg 直播命令

    ```
    # 推流 将 out.mp4  流推送到 rtmp服务器
    ffmpeg -re -i out.mp4 -c copy -f flv rtmp://server/live/streamName
    # -f flv: 推送格式是 flv
    # streamName：流的名字，自己指定，如 chatroom
    ```

    ```
    # 拉流后写到本地文件
    ffmpeg -i rtmp://server/live/streanName -c copy dump.flv
    ```

    ```
    # 使用 ffplay 播放
    ffmplay rtmp://localhost:1935/live/room
    # 网络播放器播放
    http://bbs.chinaffmpeg.com/1.swf
    ```

    